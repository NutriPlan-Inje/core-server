<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Chat</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px;
            background-color: #f0f0f0;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #sendBtn, #joinRoomBtn {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        #sendBtn:hover, #joinRoomBtn:hover {
            background-color: #0056b3;
        }

        .message {
            max-width: 70%;
            margin: 5px 0;
            padding: 10px;
            border-radius: 10px;
        }

        .user-message {
            align-self: flex-end; /* ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ */
            background-color: #e0f7fa;
            text-align: right;
        }

        .bot-message {
            align-self: flex-start; /* ì±—ë´‡ ë©”ì‹œì§€ëŠ” ì™¼ìª½ */
            background-color: #d1c4e9;
            text-align: left;
        }

        #roomInfo {
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
            color: #555;
        }

        .typing-indicator {
            font-style: italic;
            color: gray;
            margin: 5px 0;
            align-self: flex-start;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div id="roomInfo">Not connected to any room</div>
        <button id="joinRoomBtn">Join Room</button>
        <div id="messages"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        const socket = io("http://3.38.175.70", { path: "/bot" });

        const roomInfoDiv = document.getElementById("roomInfo");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const joinRoomBtn = document.getElementById("joinRoomBtn");

        let currentRoomId = null; // í˜„ì¬ ê°€ì…ëœ ë°© ID
        let typingIndicator = null; // "ì…ë ¥ ì¤‘..." ë©”ì‹œì§€ DOM ìš”ì†Œ

        // ë°©ì— ê°€ì…í•˜ê¸° ë²„íŠ¼ í´ë¦­
        joinRoomBtn.addEventListener("click", () => {
            socket.emit("create room", {u_id : 6, date : "2024-11-21"}); // ë°© ìƒì„± ìš”ì²­
            appendMessage("ğŸ”„ Creating a room...", "bot");
        });

        // ë°© ìƒì„± ì´ë²¤íŠ¸ ì‘ë‹µ
        socket.on("room created", (data) => {
            currentRoomId = data.cr_id; // ì„œë²„ì—ì„œ ë°›ì€ ë°© ID ì €ì¥
            socket.emit("join room", { cr_id: currentRoomId }); // ë°©ì— ì°¸ì—¬ ìš”ì²­
        });

        // ë°© ì°¸ì—¬ ì„±ê³µ ì´ë²¤íŠ¸
        socket.on("room joined", (data) => {
            currentRoomId = data.cr_id;
            roomInfoDiv.textContent = `Joined Room: ${data.cr_id}`;
            appendMessage(`âœ… Successfully joined room: ${data.cr_id}`, "bot");
        });

        // ë©”ì‹œì§€ ì „ì†¡
        sendBtn.addEventListener("click", () => {
            const msg = messageInput.value.trim();
            if (msg && currentRoomId) {
                appendMessage("ğŸ§‘â€ğŸ’» " + msg, "user");
                showTypingIndicator(); // "ì…ë ¥ ì¤‘..." í‘œì‹œ
                socket.emit("chat message", { roomId: currentRoomId, msg, u_id : 6 });
                messageInput.value = "";
            } else {
                appendMessage("âš ï¸ Please enter a message and ensure you're in a room.", "bot");
            }
        });

        // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ í‘œì‹œ
        socket.on("chat message", (data) => {
            hideTypingIndicator(); // "ì…ë ¥ ì¤‘..." ìˆ¨ê¹€
            appendMessage("ğŸ¤– " + data.answer, "bot");
        });

        // ì˜¤ë¥˜ ì²˜ë¦¬
        socket.on("error", (error) => {
            hideTypingIndicator(); // "ì…ë ¥ ì¤‘..." ìˆ¨ê¹€
            appendMessage("âŒ Error: " + (error.message || error), "bot");
        });

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function appendMessage(text, sender) {
            const messageElement = document.createElement("div");
            messageElement.textContent = text;
            messageElement.classList.add("message");

            if (sender === "user") {
                messageElement.classList.add("user-message");
            } else {
                messageElement.classList.add("bot-message");
            }

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        }

        // "ì…ë ¥ ì¤‘..." í‘œì‹œ
        function showTypingIndicator() {
            if (!typingIndicator) {
                typingIndicator = document.createElement("div");
                typingIndicator.textContent = "ğŸ¤– Bot is typing...";
                typingIndicator.classList.add("typing-indicator");
                messagesDiv.appendChild(typingIndicator);
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
            }
        }

        // "ì…ë ¥ ì¤‘..." ìˆ¨ê¹€
        function hideTypingIndicator() {
            if (typingIndicator) {
                messagesDiv.removeChild(typingIndicator);
                typingIndicator = null;
            }
        }
    </script>
</body>
</html>
